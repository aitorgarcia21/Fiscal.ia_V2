<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Francis Desktop</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0A192F 0%, #162238 100%);
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: rgba(22, 34, 56, 0.9);
            padding: 12px 16px;
            border-bottom: 1px solid rgba(197, 165, 114, 0.2);
            text-align: center;
        }

        .header h1 {
            color: #c5a572;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .header .subtitle {
            color: #8892b0;
            font-size: 12px;
            margin-top: 2px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 16px;
            overflow-y: auto;
        }

        .feature-section {
            background: rgba(22, 34, 56, 0.6);
            border: 1px solid rgba(197, 165, 114, 0.2);
            border-radius: 8px;
            padding: 16px;
        }

        .feature-title {
            color: #c5a572;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-icon {
            width: 20px;
            height: 20px;
            background: #c5a572;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #0A192F;
        }

        /* Audio Recording Section */
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .record-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .record-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .record-btn.recording {
            background: linear-gradient(135deg, #32ff7e, #7bed9f);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(50, 255, 126, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(50, 255, 126, 0); }
            100% { box-shadow: 0 0 0 0 rgba(50, 255, 126, 0); }
        }

        .audio-status {
            flex: 1;
            font-size: 12px;
            color: #8892b0;
        }

        .audio-status.recording {
            color: #32ff7e;
            font-weight: 600;
        }

        /* Chat Section */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 120px;
        }

        .chat-messages {
            flex: 1;
            background: rgba(10, 25, 47, 0.5);
            border-radius: 6px;
            padding: 8px;
            overflow-y: auto;
            margin-bottom: 8px;
            font-size: 12px;
            line-height: 1.4;
        }

        .chat-input {
            background: rgba(10, 25, 47, 0.7);
            border: 1px solid rgba(197, 165, 114, 0.3);
            border-radius: 6px;
            color: #ffffff;
            padding: 8px;
            font-size: 12px;
            resize: none;
            height: 32px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #c5a572;
        }

        /* Page Fill Section */
        .page-fill-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .page-selector {
            background: rgba(10, 25, 47, 0.7);
            border: 1px solid rgba(197, 165, 114, 0.3);
            border-radius: 6px;
            color: #ffffff;
            padding: 8px;
            font-size: 12px;
        }

        .page-selector:focus {
            outline: none;
            border-color: #c5a572;
        }

        .fill-btn {
            background: linear-gradient(135deg, #c5a572, #d4af37);
            border: none;
            border-radius: 6px;
            color: #0A192F;
            padding: 10px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fill-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(197, 165, 114, 0.3);
        }

        .fill-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-connected {
            background: #32ff7e;
        }

        .status-disconnected {
            background: #ff6b6b;
        }

        .status-processing {
            background: #ffa726;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 4px;">
            <!-- Logo Francis EXACT du favicon.svg -->
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="30" viewBox="0 0 120 114" version="1.1" style="transition: transform 0.3s ease;">
              <defs>
                <clipPath id="roundedRect">
                  <rect x="0" y="0" width="120" height="114" rx="20" ry="20"/>
                </clipPath>
              </defs>
              <g clip-path="url(#roundedRect)">
                <path d="M 29.062 24.601 L 25.971 27.202 26.235 57.338 C 26.549 93.040, 26.190 92.220, 36.876 81.636 L 43.500 75.076 51.838 74.788 L 60.176 74.500 61.540 71.250 L 62.903 68 52.155 68 L 41.406 68 37.500 72 C 35.352 74.200, 33.212 76, 32.745 76 C 32.278 76, 32.031 65.633, 32.198 52.962 C 32.449 33.817, 32.753 29.760, 34 28.950 C 34.899 28.365, 45.232 28.080, 59.788 28.237 C 80.090 28.457, 84.231 28.746, 85.022 30 C 85.543 30.825, 85.976 36.787, 85.985 43.250 L 86 55 89 55 L 92 55 92 41.577 C 92 28.595, 91.915 28.052, 89.411 25.077 L 86.822 22 59.488 22 L 32.153 22 29.062 24.601 M 83.459 66.880 C 79.686 68.593, 74 74.080, 74 76.007 C 74 76.477, 73.023 77.005, 71.828 77.180 C 68.906 77.610, 68.270 79.996, 70.895 80.683 C 72.053 80.986, 73 82.028, 73 83 C 73 83.972, 72.053 85.014, 70.895 85.317 C 68.326 85.989, 68.863 88.249, 71.764 88.972 C 72.928 89.263, 74.920 91.034, 76.190 92.908 C 79.594 97.931, 83.254 100.222, 88.710 100.746 C 96.226 101.468, 106.193 96.091, 102.066 93.541 C 101.552 93.223, 99.296 93.920, 97.051 95.090 C 93.947 96.708, 92.078 97.051, 89.235 96.524 C 85.495 95.831, 79 91.690, 79 89.999 C 79 89.504, 81.588 88.965, 84.750 88.800 C 89.061 88.575, 90.500 88.125, 90.500 87 C 90.500 85.844, 88.952 85.432, 83.750 85.204 C 77.866 84.947, 77 84.663, 77 82.991 C 77 81.250, 77.905 81.046, 86.750 80.786 C 94.623 80.555, 96.500 80.211, 96.500 79 C 96.500 77.803, 94.733 77.442, 87.750 77.211 C 82.938 77.052, 79 76.530, 79 76.050 C 79 74.333, 85.123 70.068, 88.497 69.435 C 91.006 68.964, 93.179 69.392, 96.542 71.020 C 104.095 74.677, 105.363 70.308, 97.872 66.434 C 94.108 64.487, 88.332 64.666, 83.459 66.880" stroke="none" fill="#c2a273" fill-rule="evenodd"/>
                <path d="M 0 57.008 L 0 114.016 60.250 113.758 L 120.500 113.500 120.758 56.750 L 121.017 0 60.508 0 L 0 0 0 57.008 M 0.468 57.500 C 0.468 88.850, 0.595 101.530, 0.750 85.679 C 0.904 69.827, 0.904 44.177, 0.749 28.679 C 0.594 13.180, 0.468 26.150, 0.468 57.500 M 29.062 24.601 L 25.971 27.202 26.235 57.338 C 26.549 93.040, 26.190 92.220, 36.876 81.636 L 43.500 75.076 51.838 74.788 L 60.176 74.500 61.540 71.250 L 62.903 68 52.155 68 L 41.406 68 37.500 72 C 35.352 74.200, 33.212 76, 32.745 76 C 32.278 76, 32.031 65.633, 32.198 52.962 C 32.449 33.817, 32.753 29.760, 34 28.950 C 34.899 28.365, 45.232 28.080, 59.788 28.237 C 80.090 28.457, 84.231 28.746, 85.022 30 C 85.543 30.825, 85.976 36.787, 85.985 43.250 L 86 55 89 55 L 92 55 92 41.577 C 92 28.595, 91.915 28.052, 89.411 25.077 L 86.822 22 59.488 22 L 32.153 22 29.062 24.601 M 83.459 66.880 C 79.686 68.593, 74 74.080, 74 76.007 C 74 76.477, 73.023 77.005, 71.828 77.180 C 68.906 77.610, 68.270 79.996, 70.895 80.683 C 72.053 80.986, 73 82.028, 73 83 C 73 83.972, 72.053 85.014, 70.895 85.317 C 68.326 85.989, 68.863 88.249, 71.764 88.972 C 72.928 89.263, 74.920 91.034, 76.190 92.908 C 79.594 97.931, 83.254 100.222, 88.710 100.746 C 96.226 101.468, 106.193 96.091, 102.066 93.541 C 101.552 93.223, 99.296 93.920, 97.051 95.090 C 93.947 96.708, 92.078 97.051, 89.235 96.524 C 85.495 95.831, 79 91.690, 79 89.999 C 79 89.504, 81.588 88.965, 84.750 88.800 C 89.061 88.575, 90.500 88.125, 90.500 87 C 90.500 85.844, 88.952 85.432, 83.750 85.204 C 77.866 84.947, 77 84.663, 77 82.991 C 77 81.250, 77.905 81.046, 86.750 80.786 C 94.623 80.555, 96.500 80.211, 96.500 79 C 96.500 77.803, 94.733 77.442, 87.750 77.211 C 82.938 77.052, 79 76.530, 79 76.050 C 79 74.333, 85.123 70.068, 88.497 69.435 C 91.006 68.964, 93.179 69.392, 96.542 71.020 C 104.095 74.677, 105.363 70.308, 97.872 66.434 C 94.108 64.487, 88.332 64.666, 83.459 66.880" stroke="none" fill="#14243c" fill-rule="evenodd"/>
              </g>
            </svg>
            <h1 style="margin: 0; color: #c5a572; font-size: 18px; font-weight: 600;">Francis Desktop</h1>
        </div>
    </div>

    <div class="main-content">
        <!-- Audio Recording Section -->
        <div class="feature-section">
            <div class="feature-title">
                <div class="feature-icon">🎤</div>
                Enregistrement Audio
            </div>
            <div class="audio-controls">
                <button class="record-btn" id="recordBtn">
                    <span id="recordIcon">●</span>
                </button>
                <div class="audio-status" id="audioStatus">
                    <span class="status-indicator status-disconnected"></span>
                    Prêt à enregistrer
                </div>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="feature-section">
            <div class="feature-title">
                <div class="feature-icon">💬</div>
                Chat Francis
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div style="color: #c5a572; font-style: italic;">Francis: Bonjour ! Comment puis-je vous aider ?</div>
                </div>
                <textarea class="chat-input" id="chatInput" placeholder="Tapez votre message..." rows="1"></textarea>
            </div>
        </div>

        <!-- Page Fill Section -->
        <div class="feature-section">
            <div class="feature-title">
                <div class="feature-icon">📝</div>
                Remplir Page
            </div>
            <div class="page-fill-controls">
                <select class="page-selector" id="pageSelector">
                    <option value="">Sélectionner une page...</option>
                    <option value="browser-1">🌐 Safari - Formulaire Client</option>
                    <option value="browser-2">🌐 Chrome - CRM Patrimoine</option>
                    <option value="app-1">📊 Excel - Tableau Fiscal</option>
                    <option value="app-2">📄 PDF - Déclaration Revenus</option>
                </select>
                <button class="fill-btn" id="fillBtn" disabled>
                    Remplir automatiquement
                </button>
            </div>
        </div>
    </div>

    <script>
        // Audio Recording Logic
        let isRecording = false;
        let mediaRecorder = null;

        const recordBtn = document.getElementById('recordBtn');
        const recordIcon = document.getElementById('recordIcon');
        const audioStatus = document.getElementById('audioStatus');

        recordBtn.addEventListener('click', toggleRecording);

        async function toggleRecording() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.start();
                    isRecording = true;
                    
                    recordBtn.classList.add('recording');
                    recordIcon.textContent = '⏹';
                    audioStatus.innerHTML = '<span class="status-indicator status-processing"></span>Enregistrement en cours...';
                    audioStatus.classList.add('recording');
                    
                    // Send to Francis for processing
                    window.electronAPI.startRecording();
                    
                } catch (error) {
                    console.error('Erreur microphone:', error);
                    audioStatus.innerHTML = '<span class="status-indicator status-disconnected"></span>Erreur microphone';
                }
            } else {
                stopRecording();
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                isRecording = false;
                recordBtn.classList.remove('recording');
                recordIcon.textContent = '●';
                audioStatus.innerHTML = '<span class="status-indicator status-connected"></span>Traitement Francis...';
                audioStatus.classList.remove('recording');
                
                // Process with Francis
                window.electronAPI.stopRecording();
                
                setTimeout(() => {
                    audioStatus.innerHTML = '<span class="status-indicator status-disconnected"></span>Prêt à enregistrer';
                }, 2000);
            }
        }

        // Chat Logic
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');

        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function getAuthToken() {
            // Récupérer le token depuis le localStorage (si accessible)
            try {
                return localStorage.getItem('authToken');
            } catch (e) {
                console.log('Pas d\'accès au localStorage dans Electron');
                return null;
            }
        }

        function addChatMessage(message, sender, id) {
            const msg = document.createElement('div');
            msg.style.marginBottom = '8px';
            if (sender === 'user') {
                msg.style.textAlign = 'right';
                msg.innerHTML = `<span style="color: #64ffda;">Vous:</span> ${message}`;
            } else {
                msg.innerHTML = `<span style="color: #c5a572;">Francis:</span> ${message}`;
            }
            if (id) {
                msg.id = id;
            }
            chatMessages.appendChild(msg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            chatInput.value = '';

            const thinkingId = 'thinking-' + Date.now();
            addChatMessage('Francis analyse votre question...', 'bot', thinkingId);

            const authToken = getAuthToken();
            
            window.electronAPI.sendChatMessage(message, authToken).then(response => {
                const thinkingElement = document.getElementById(thinkingId);
                if (thinkingElement) {
                    thinkingElement.remove();
                }
                
                addChatMessage(response, 'bot');
            }).catch(error => {
                const thinkingElement = document.getElementById(thinkingId);
                if (thinkingElement) {
                    thinkingElement.remove();
                }
                
                addChatMessage('Désolé, une erreur s\'est produite. Veuillez réessayer.', 'bot');
                console.error('Erreur Francis Chat:', error);
            });
        }

        // Page Fill Logic
        const pageSelector = document.getElementById('pageSelector');
        const fillBtn = document.getElementById('fillBtn');

        pageSelector.addEventListener('change', function() {
            fillBtn.disabled = !this.value;
        });

        fillBtn.addEventListener('click', function() {
            const selectedPage = pageSelector.value;
            if (!selectedPage) return;

            fillBtn.textContent = 'Remplissage en cours...';
            fillBtn.disabled = true;

            // Send to Francis for page filling
            window.electronAPI.fillPage(selectedPage, {}).then(result => {
                if (result.success) {
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.style.color = '#32ff7e';
                    successMsg.style.fontSize = '11px';
                    successMsg.style.marginTop = '4px';
                    successMsg.textContent = '✅ Page remplie avec succès !';
                    fillBtn.parentNode.appendChild(successMsg);
                    
                    setTimeout(() => {
                        successMsg.remove();
                    }, 3000);
                } else {
                    // Show error message
                    const errorMsg = document.createElement('div');
                    errorMsg.style.color = '#ff6b6b';
                    errorMsg.style.fontSize = '11px';
                    errorMsg.style.marginTop = '4px';
                    errorMsg.textContent = '❌ Erreur lors du remplissage';
                    fillBtn.parentNode.appendChild(errorMsg);
                    
                    setTimeout(() => {
                        errorMsg.remove();
                    }, 3000);
                }
            });

            setTimeout(() => {
                fillBtn.textContent = 'Remplir automatiquement';
                fillBtn.disabled = false;
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.style.color = '#32ff7e';
                successMsg.style.fontSize = '11px';
                successMsg.style.marginTop = '4px';
                successMsg.textContent = '✅ Page remplie avec succès !';
                fillBtn.parentNode.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
            }, 2000);
        });

        // Load available pages on startup
        window.electronAPI.getOpenPages().then(pages => {
            pageSelector.innerHTML = '<option value="">Sélectionner une page...</option>';
            pages.forEach(page => {
                const option = document.createElement('option');
                option.value = page.id;
                option.textContent = `${page.icon} ${page.title}`;
                pageSelector.appendChild(option);
            });
        });

        // Auto-resize chat input
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 60) + 'px';
        });
    </script>
</body>
</html>
