{% extends "pro_layout.html" %}

{% block title %}Modifier Questionnaire - {{ client.nom_complet or client.id }} - Francis{% endblock %}

{% block header_title %}Francis - Modifier le Questionnaire Client{% endblock %}

{% block content %}
    <div class="nav-links">
        <a href="{{ url_for('pro_voir_questionnaire', client_id=client_id, questionnaire_id=questionnaire_id) }}">&larr; Annuler et Retourner à la Visualisation</a>
    </div>

    {% if error_messages %}
        <div class="error-summary">
            <p><strong>Erreurs de validation :</strong></p>
            <ul>
                {% for error in error_messages %}
                    <li>{{ error.loc | join('.') if error.loc else 'Erreur générale' }}: {{ error.msg }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    {% set q = questionnaire %} <!-- Alias pour les données du questionnaire existant -->
    {% set fd = form_data or {} %} <!-- Alias pour les données du formulaire soumises en cas d'erreur -->
    
    <form action="{{ url_for('pro_modifier_questionnaire', client_id=client_id, questionnaire_id=questionnaire_id) }}" method="POST">
        
        <fieldset>
            <legend>Identité</legend>
            <div class="form-group">
                <label for="identite_nom">Nom :</label>
                <input type="text" id="identite_nom" name="identite_nom" value="{{ fd.get('identite_nom', q.identite.nom if q and q.identite else '') }}" required>
            </div>
            <div class="form-group">
                <label for="identite_prenom">Prénom :</label>
                <input type="text" id="identite_prenom" name="identite_prenom" value="{{ fd.get('identite_prenom', q.identite.prenom if q and q.identite else '') }}" required>
            </div>
            <div class="form-group">
                <label for="identite_date_naissance">Date de naissance :</label>
                <input type="date" id="identite_date_naissance" name="identite_date_naissance" value="{{ fd.get('identite_date_naissance', q.identite.date_naissance if q and q.identite else '') }}" required>
            </div>
            <div class="form-group">
                <label for="identite_situation_familiale">Situation familiale :</label>
                <select id="identite_situation_familiale" name="identite_situation_familiale" required>
                    {% set current_sit = fd.get('identite_situation_familiale', q.identite.situation_familiale if q and q.identite else '') %}
                    <option value="celibataire" {% if current_sit == 'celibataire' %}selected{% endif %}>Célibataire</option>
                    <option value="marie" {% if current_sit == 'marie' %}selected{% endif %}>Marié(e)</option>
                    <option value="pacse" {% if current_sit == 'pacse' %}selected{% endif %}>Pacsé(e)</option>
                    <option value="divorce" {% if current_sit == 'divorce' %}selected{% endif %}>Divorcé(e)</option>
                    <option value="veuf" {% if current_sit == 'veuf' %}selected{% endif %}>Veuf/Veuve</option>
                </select>
            </div>
            <div class="form-group">
                <label for="identite_enfants">Nombre d'enfants à charge :</label>
                <input type="number" id="identite_enfants" name="identite_enfants" min="0" value="{{ fd.get('identite_enfants', q.identite.enfants if q and q.identite else 0) }}" required>
            </div>
        </fieldset>

        <fieldset>
            <legend>Revenus et Charges Annuels (€)</legend>
            {% set rc_q = q.revenus_charges if q else None %}
            <div class="form-group">
                <label for="revenus_charges_salaires">Salaires et traitements :</label>
                <input type="number" id="revenus_charges_salaires" name="revenus_charges_salaires" min="0" step="any" value="{{ fd.get('revenus_charges_salaires', rc_q.salaires if rc_q and rc_q.salaires is not None else '') }}" placeholder="0">
            </div>
            <div class="form-group">
                <label for="revenus_charges_pensions">Pensions, retraites :</label>
                <input type="number" id="revenus_charges_pensions" name="revenus_charges_pensions" min="0" step="any" value="{{ fd.get('revenus_charges_pensions', rc_q.pensions if rc_q and rc_q.pensions is not None else '') }}" placeholder="0">
            </div>
            <div class="form-group">
                <label for="revenus_charges_revenus_locatifs">Revenus locatifs bruts :</label>
                <input type="number" id="revenus_charges_revenus_locatifs" name="revenus_charges_revenus_locatifs" min="0" step="any" value="{{ fd.get('revenus_charges_revenus_locatifs', rc_q.revenus_locatifs if rc_q and rc_q.revenus_locatifs is not None else '') }}" placeholder="0">
            </div>
            <div class="form-group">
                <label for="revenus_charges_autres_revenus">Autres revenus :</label>
                <input type="number" id="revenus_charges_autres_revenus" name="revenus_charges_autres_revenus" min="0" step="any" value="{{ fd.get('revenus_charges_autres_revenus', rc_q.autres_revenus if rc_q and rc_q.autres_revenus is not None else '') }}" placeholder="0">
            </div>
            <div class="form-group">
                <label for="revenus_charges_charges_deductibles">Charges déductibles (hors PER) :</label>
                <input type="number" id="revenus_charges_charges_deductibles" name="revenus_charges_charges_deductibles" min="0" step="any" value="{{ fd.get('revenus_charges_charges_deductibles', rc_q.charges_deductibles if rc_q and rc_q.charges_deductibles is not None else '') }}" placeholder="0">
            </div>
            <div class="form-group">
                <label for="revenus_charges_revenu_professionnel_n1">Revenu professionnel N-1 :</label>
                <input type="number" id="revenus_charges_revenu_professionnel_n1" name="revenus_charges_revenu_professionnel_n1" min="0" step="any" value="{{ fd.get('revenus_charges_revenu_professionnel_n1', rc_q.revenu_professionnel_n1 if rc_q and rc_q.revenu_professionnel_n1 is not None else '') }}" placeholder="Optionnel">
                <small>Revenu net de l'activité professionnelle de l'année N-1.</small>
            </div>
            <div class="form-group">
                <label for="revenus_charges_disponible_fiscal_per_n">Disponible fiscal PER (avis N) :</label>
                <input type="number" id="revenus_charges_disponible_fiscal_per_n" name="revenus_charges_disponible_fiscal_per_n" min="0" step="any" value="{{ fd.get('revenus_charges_disponible_fiscal_per_n', rc_q.disponible_fiscal_per_n if rc_q and rc_q.disponible_fiscal_per_n is not None else '') }}" placeholder="Optionnel">
                <small>Disponible pour versements PER indiqué sur l'avis d'imposition des revenus N-1.</small>
            </div>
        </fieldset>
        
        <fieldset>
            <legend>Patrimoine Immobilier (€)</legend>
            {% set pi_q = q.patrimoine_immobilier if q else None %}
            <div class="form-group">
                <label for="patrimoine_immobilier_residence_principale_valeur_brute">Valeur brute Résidence Principale :</label>
                <input type="number" id="patrimoine_immobilier_residence_principale_valeur_brute" name="patrimoine_immobilier_residence_principale_valeur_brute" min="0" step="any" value="{{ fd.get('patrimoine_immobilier_residence_principale_valeur_brute', pi_q.residence_principale_valeur_brute if pi_q and pi_q.residence_principale_valeur_brute is not None else '') }}" placeholder="0">
            </div>
            <div class="form-group">
                <label for="patrimoine_immobilier_residences_secondaires_valeur_brute">Total valeur brute Résidences Secondaires :</label>
                <input type="number" id="patrimoine_immobilier_residences_secondaires_valeur_brute" name="patrimoine_immobilier_residences_secondaires_valeur_brute" min="0" step="any" value="{{ fd.get('patrimoine_immobilier_residences_secondaires_valeur_brute', pi_q.residences_secondaires_valeur_brute if pi_q and pi_q.residences_secondaires_valeur_brute is not None else '') }}" placeholder="0">
            </div>
            <div class="form-group">
                <label for="patrimoine_immobilier_immobilier_locatif_valeur_brute">Total valeur brute Immobilier Locatif (hors SCI) :</label>
                <input type="number" id="patrimoine_immobilier_immobilier_locatif_valeur_brute" name="patrimoine_immobilier_immobilier_locatif_valeur_brute" min="0" step="any" value="{{ fd.get('patrimoine_immobilier_immobilier_locatif_valeur_brute', pi_q.immobilier_locatif_valeur_brute if pi_q and pi_q.immobilier_locatif_valeur_brute is not None else '') }}" placeholder="0">
            </div>
            <div class="form-group">
                <label for="patrimoine_immobilier_sci_parts_valeur_nette">Valeur nette parts de SCI (pour IFI) :</label>
                <input type="number" id="patrimoine_immobilier_sci_parts_valeur_nette" name="patrimoine_immobilier_sci_parts_valeur_nette" min="0" step="any" value="{{ fd.get('patrimoine_immobilier_sci_parts_valeur_nette', pi_q.sci_parts_valeur_nette if pi_q and pi_q.sci_parts_valeur_nette is not None else '') }}" placeholder="0">
            </div>
        </fieldset>

        <fieldset>
            <legend>Patrimoine Financier (€)</legend>
            {% set pf_q = q.patrimoine_financier if q else None %}
            <div class="form-group">
                <label for="patrimoine_financier_pea">PEA (valeur totale) :</label>
                <input type="number" id="patrimoine_financier_pea" name="patrimoine_financier_pea" min="0" step="any" value="{{ fd.get('patrimoine_financier_pea', pf_q.pea if pf_q and pf_q.pea is not None else '') }}" placeholder="0">
            </div>
            <div class="form-group">
                <label for="patrimoine_financier_assurance_vie">Assurance Vie (fraction taxable IFI) :</label>
                <input type="number" id="patrimoine_financier_assurance_vie" name="patrimoine_financier_assurance_vie" min="0" step="any" value="{{ fd.get('patrimoine_financier_assurance_vie', pf_q.assurance_vie if pf_q and pf_q.assurance_vie is not None else '') }}" placeholder="0">
                <small>Uniquement la fraction taxable à l'IFI.</small>
            </div>
            <div class="form-group">
                <label for="patrimoine_financier_compte_titres">Compte-Titres Ordinaire (valeur totale) :</label>
                <input type="number" id="patrimoine_financier_compte_titres" name="patrimoine_financier_compte_titres" min="0" step="any" value="{{ fd.get('patrimoine_financier_compte_titres', pf_q.compte_titres if pf_q and pf_q.compte_titres is not None else '') }}" placeholder="0">
            </div>
            <div class="form-group">
                <label for="patrimoine_financier_crypto">Crypto-actifs (valeur totale) :</label>
                <input type="number" id="patrimoine_financier_crypto" name="patrimoine_financier_crypto" min="0" step="any" value="{{ fd.get('patrimoine_financier_crypto', pf_q.crypto if pf_q and pf_q.crypto is not None else '') }}" placeholder="0">
            </div>
            <div class="form-group">
                <label for="patrimoine_financier_liquidites">Liquidités (comptes courants, livrets) :</label>
                <input type="number" id="patrimoine_financier_liquidites" name="patrimoine_financier_liquidites" min="0" step="any" value="{{ fd.get('patrimoine_financier_liquidites', pf_q.liquidites if pf_q and pf_q.liquidites is not None else '') }}" placeholder="0">
            </div>
            <div class="form-group">
                <label for="patrimoine_financier_autres_actifs_ifi">Autres actifs entrant dans l'IFI :</label>
                <input type="number" id="patrimoine_financier_autres_actifs_ifi" name="patrimoine_financier_autres_actifs_ifi" min="0" step="any" value="{{ fd.get('patrimoine_financier_autres_actifs_ifi', pf_q.autres_actifs_ifi if pf_q and pf_q.autres_actifs_ifi is not None else '') }}" placeholder="0">
                <small>Ex: objets d'art si non exonérés.</small>
            </div>
        </fieldset>
        
        <fieldset>
            <legend>Dettes Déductibles pour l'IFI (€) (Optionnel)</legend>
            {% set di_q = q.dettes_ifi_deductibles if q else None %}
            <div class="form-group">
                <label for="dettes_ifi_emprunt_rp_capital_restant_du">CRD Emprunt Résidence Principale (part IFI) :</label>
                <input type="number" id="dettes_ifi_emprunt_rp_capital_restant_du" name="dettes_ifi_emprunt_rp_capital_restant_du" min="0" step="any" value="{{ fd.get('dettes_ifi_emprunt_rp_capital_restant_du', di_q.emprunt_rp_capital_restant_du if di_q and di_q.emprunt_rp_capital_restant_du is not None else '') }}" placeholder="Optionnel">
            </div>
            <div class="form-group">
                <label for="dettes_ifi_emprunts_rs_capital_restant_du">Total CRD Emprunts Résidences Secondaires :</label>
                <input type="number" id="dettes_ifi_emprunts_rs_capital_restant_du" name="dettes_ifi_emprunts_rs_capital_restant_du" min="0" step="any" value="{{ fd.get('dettes_ifi_emprunts_rs_capital_restant_du', di_q.emprunts_rs_capital_restant_du if di_q and di_q.emprunts_rs_capital_restant_du is not None else '') }}" placeholder="Optionnel">
            </div>
            <div class="form-group">
                <label for="dettes_ifi_emprunts_locatif_capital_restant_du">Total CRD Emprunts Immobilier Locatif (hors SCI) :</label>
                <input type="number" id="dettes_ifi_emprunts_locatif_capital_restant_du" name="dettes_ifi_emprunts_locatif_capital_restant_du" min="0" step="any" value="{{ fd.get('dettes_ifi_emprunts_locatif_capital_restant_du', di_q.emprunts_locatif_capital_restant_du if di_q and di_q.emprunts_locatif_capital_restant_du is not None else '') }}" placeholder="Optionnel">
            </div>
            <div class="form-group">
                <label for="dettes_ifi_autres_dettes_ifi">Autres dettes déductibles IFI :</label>
                <input type="number" id="dettes_ifi_autres_dettes_ifi" name="dettes_ifi_autres_dettes_ifi" min="0" step="any" value="{{ fd.get('dettes_ifi_autres_dettes_ifi', di_q.autres_dettes_ifi if di_q and di_q.autres_dettes_ifi is not None else '') }}" placeholder="Optionnel">
            </div>
        </fieldset>

        <fieldset>
            <legend>Objectifs Patrimoniaux</legend>
            {% set obj_q = q.objectifs if q else None %}
            <div class="form-group">
                <input type="checkbox" id="objectifs_retraite" name="objectifs_retraite" value="on" {% if fd.get('objectifs_retraite', obj_q.retraite if obj_q else False) == 'on' or (obj_q and obj_q.retraite and fd.get('objectifs_retraite') is none) %}checked{% endif %}> 
                <label for="objectifs_retraite" class="checkbox-label">Préparer la retraite</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="objectifs_transmission" name="objectifs_transmission" value="on" {% if fd.get('objectifs_transmission', obj_q.transmission if obj_q else False) == 'on' or (obj_q and obj_q.transmission and fd.get('objectifs_transmission') is none) %}checked{% endif %}> 
                <label for="objectifs_transmission" class="checkbox-label">Anticiper la transmission</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="objectifs_reduction_ir" name="objectifs_reduction_ir" value="on" {% if fd.get('objectifs_reduction_ir', obj_q.reduction_ir if obj_q else False) == 'on' or (obj_q and obj_q.reduction_ir and fd.get('objectifs_reduction_ir') is none) %}checked{% endif %}> 
                <label for="objectifs_reduction_ir" class="checkbox-label">Réduire l'Impôt sur le Revenu</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="objectifs_optimisation_ifi" name="objectifs_optimisation_ifi" value="on" {% if fd.get('objectifs_optimisation_ifi', obj_q.optimisation_ifi if obj_q else False) == 'on' or (obj_q and obj_q.optimisation_ifi and fd.get('objectifs_optimisation_ifi') is none) %}checked{% endif %}> 
                <label for="objectifs_optimisation_ifi" class="checkbox-label">Optimiser l'IFI</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="objectifs_revenus_complementaires" name="objectifs_revenus_complementaires" value="on" {% if fd.get('objectifs_revenus_complementaires', obj_q.revenus_complementaires if obj_q else False) == 'on' or (obj_q and obj_q.revenus_complementaires and fd.get('objectifs_revenus_complementaires') is none) %}checked{% endif %}> 
                <label for="objectifs_revenus_complementaires" class="checkbox-label">Générer des revenus complémentaires</label>
            </div>
            <div class="form-group">
                <label for="objectifs_montant_donation_envisagee">Montant d'une donation envisagée (€) :</label>
                <input type="number" id="objectifs_montant_donation_envisagee" name="objectifs_montant_donation_envisagee" min="0" step="any" value="{{ fd.get('objectifs_montant_donation_envisagee', obj_q.montant_donation_envisagee if obj_q and obj_q.montant_donation_envisagee is not None else '') }}" placeholder="Optionnel">
                <small>Pour simulation impact IFI d'une donation.</small>
            </div>
        </fieldset>
        
        <fieldset>
            <legend>Données pour Optimisations Spécifiques (Optionnel)</legend>
            {% set ospec_q = q.optimisations_specifiques if q else None %}
            <div class="form-group">
                <label>PVI: Prix de cession envisagé (€) :</label>
                <input type="number" name="opti_pvi_prix_cession_envisage" min="0" step="any" value="{{ fd.get('opti_pvi_prix_cession_envisage', ospec_q.pvi_prix_cession_envisage if ospec_q and ospec_q.pvi_prix_cession_envisage is not None else '') }}" placeholder="Optionnel">
            </div>
            <div class="form-group">
                <label>PVI: Prix d'acquisition estimé (€) :</label>
                <input type="number" name="opti_pvi_prix_acquisition_estime" min="0" step="any" value="{{ fd.get('opti_pvi_prix_acquisition_estime', ospec_q.pvi_prix_acquisition_estime if ospec_q and ospec_q.pvi_prix_acquisition_estime is not None else '') }}" placeholder="Optionnel">
            </div>
            <div class="form-group">
                <label>PVI: Durée de détention estimée (années) :</label>
                <input type="number" name="opti_pvi_duree_detention_estimee" min="0" value="{{ fd.get('opti_pvi_duree_detention_estimee', ospec_q.pvi_duree_detention_estimee if ospec_q and ospec_q.pvi_duree_detention_estimee is not None else '') }}" placeholder="Optionnel">
            </div>
            <div class="form-group">
                <label>PVI: Frais d'acquisition réels (€) :</label>
                <input type="number" name="opti_pvi_frais_acquisition_reels" min="0" step="any" value="{{ fd.get('opti_pvi_frais_acquisition_reels', ospec_q.pvi_frais_acquisition_reels if ospec_q and ospec_q.pvi_frais_acquisition_reels is not None else '') }}" placeholder="Optionnel">
            </div>
            <div class="form-group">
                {% set pvi_forfait_frais_val = fd.get('opti_pvi_appliquer_forfait_frais_acquisition', ospec_q.pvi_appliquer_forfait_frais_acquisition if ospec_q else True) %}
                <input type="checkbox" name="opti_pvi_appliquer_forfait_frais_acquisition" value="on" {% if pvi_forfait_frais_val == 'on' or pvi_forfait_frais_val == True %}checked{% endif %}>
                <label class="checkbox-label">PVI: Appliquer forfait frais acquisition (7.5%)</label>
            </div>
            <div class="form-group">
                <label>PVI: Montant travaux déductibles (€) :</label>
                <input type="number" name="opti_pvi_montant_travaux_deductibles" min="0" step="any" value="{{ fd.get('opti_pvi_montant_travaux_deductibles', ospec_q.pvi_montant_travaux_deductibles if ospec_q and ospec_q.pvi_montant_travaux_deductibles is not None else '') }}" placeholder="Optionnel">
            </div>
            <div class="form-group">
                {% set pvi_forfait_travaux_val = fd.get('opti_pvi_appliquer_forfait_travaux', ospec_q.pvi_appliquer_forfait_travaux if ospec_q else True) %}
                <input type="checkbox" name="opti_pvi_appliquer_forfait_travaux" value="on" {% if pvi_forfait_travaux_val == 'on' or pvi_forfait_travaux_val == True %}checked{% endif %}>
                <label class="checkbox-label">PVI: Appliquer forfait travaux (15%)</label>
            </div>
            <hr style="margin: 20px 0;">
            <div class="form-group">
                <label>Dons aux œuvres: Montant annuel envisagé (€) :</label>
                <input type="number" name="opti_don_aux_oeuvres_montant" min="0" step="any" value="{{ fd.get('opti_don_aux_oeuvres_montant', ospec_q.don_aux_oeuvres_montant if ospec_q and ospec_q.don_aux_oeuvres_montant is not None else '') }}" placeholder="Optionnel">
            </div>
            <hr style="margin: 20px 0;">
            <div class="form-group">
                <label>Emploi à domicile: Dépenses annuelles (€) :</label>
                <input type="number" name="opti_emploi_domicile_depenses" min="0" step="any" value="{{ fd.get('opti_emploi_domicile_depenses', ospec_q.emploi_domicile_depenses if ospec_q and ospec_q.emploi_domicile_depenses is not None else '') }}" placeholder="Optionnel">
            </div>
        </fieldset>

        <fieldset>
            <legend>Profil Investisseur (Optionnel)</legend>
            <div class="form-group">
                <label for="profil_horizon">Horizon de placement :</label>
                <select id="profil_horizon" name="profil_horizon">
                    {% set current_horizon = fd.get('profil_horizon', q.horizon if q else '') %}
                    <option value="" {% if not current_horizon %}selected{% endif %}>Non défini</option>
                    <option value="court" {% if current_horizon == 'court' %}selected{% endif %}>Court terme</option>
                    <option value="moyen" {% if current_horizon == 'moyen' %}selected{% endif %}>Moyen terme</option>
                    <option value="long" {% if current_horizon == 'long' %}selected{% endif %}>Long terme</option>
                </select>
            </div>
            <div class="form-group">
                <label for="profil_risque">Profil de risque :</label>
                 <select id="profil_risque" name="profil_risque">
                    {% set current_risque = fd.get('profil_risque', q.profil_risque if q else '') %}
                    <option value="" {% if not current_risque %}selected{% endif %}>Non défini</option>
                    <option value="prudent" {% if current_risque == 'prudent' %}selected{% endif %}>Prudent</option>
                    <option value="modere" {% if current_risque == 'modere' %}selected{% endif %}>Modéré</option>
                    <option value="dynamique" {% if current_risque == 'dynamique' %}selected{% endif %}>Dynamique</option>
                </select>
            </div>
        </fieldset>

        <button type="submit">Enregistrer les Modifications du Questionnaire</button>
    </form>
{% endblock %} 