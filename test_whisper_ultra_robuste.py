#!/usr/bin/env python3
"""
Script de test ULTRA-ROBUSTE pour Whisper - Teste TOUS les sc√©narios possibles
"""

import requests
import base64
import json
import time
import os
import wave
import struct
import numpy as np
import subprocess
import tempfile
import sys

# Configuration
API_BASE_URL = "http://localhost:8000"
TEST_AUDIO_FILE = "test_audio.wav"

def create_speech_audio(filename, duration=3, sample_rate=16000):
    """Cr√©e un fichier audio avec de la parole simul√©e."""
    print(f"üéµ Cr√©ation audio simul√© ({duration}s)...")
    
    t = np.linspace(0, duration, int(sample_rate * duration), False)
    base_freq = 300
    modulation = 0.5 * np.sin(2 * np.pi * 2 * t) + 0.5
    freq = base_freq + 200 * modulation
    audio_data = np.sin(2 * np.pi * freq * t) * 0.3
    audio_int16 = (audio_data * 32767).astype(np.int16)
    
    with wave.open(filename, 'w') as wav_file:
        wav_file.setnchannels(1)
        wav_file.setsampwidth(2)
        wav_file.setframerate(sample_rate)
        wav_file.writeframes(audio_int16.tobytes())
    
    print(f"‚úÖ Audio simul√© cr√©√©: {filename}")

def create_real_speech_audio(filename, text="Bonjour, test de transcription Whisper.", duration=5):
    """Cr√©e un fichier audio avec de la vraie parole."""
    print(f"üé§ Cr√©ation audio r√©el: '{text}'")
    
    try:
        # Essayer say (macOS)
        subprocess.run([
            "say", "-o", filename, 
            "--file-format=WAVE",
            "--data-format=LEI16",
            "--channels=1",
            "--rate=16000",
            text
        ], check=True)
        print(f"‚úÖ Audio r√©el cr√©√© avec say: {filename}")
        return True
    except (subprocess.CalledProcessError, FileNotFoundError):
        try:
            # Essayer espeak
            subprocess.run([
                "espeak", "-w", filename,
                "-s", "150",
                "-p", "50",
                "-a", "100",
                text
            ], check=True)
            print(f"‚úÖ Audio r√©el cr√©√© avec espeak: {filename}")
            return True
        except (subprocess.CalledProcessError, FileNotFoundError):
            print("‚ö†Ô∏è  Impossible de cr√©er de la vraie parole. Utilisation de l'audio simul√©.")
            create_speech_audio(filename, duration)
            return False

def test_backend_health():
    """Test de sant√© du backend."""
    print("üè• Test sant√© backend...")
    
    try:
        response = requests.get(f"{API_BASE_URL}/health", timeout=5)
        print(f"Status: {response.status_code}")
        return response.status_code == 200
    except Exception as e:
        print(f"‚ùå Backend non accessible: {e}")
        return False

def test_whisper_service_direct():
    """Test direct du service Whisper."""
    print("üîß Test direct service Whisper...")
    
    try:
        import sys
        sys.path.append('backend')
        from whisper_service import get_whisper_service
        
        # Test avec audio simul√©
        create_speech_audio(TEST_AUDIO_FILE, duration=2)
        
        with open(TEST_AUDIO_FILE, 'rb') as f:
            audio_data = f.read()
            audio_base64 = base64.b64encode(audio_data).decode('utf-8')
        
        service = get_whisper_service()
        result = service.transcribe_base64_audio(audio_base64, "wav")
        
        print(f"R√©sultat simul√©: {json.dumps(result, indent=2)}")
        
        # Test avec audio r√©el
        success = create_real_speech_audio(TEST_AUDIO_FILE, "Bonjour, test de transcription.")
        
        with open(TEST_AUDIO_FILE, 'rb') as f:
            audio_data = f.read()
            audio_base64 = base64.b64encode(audio_data).decode('utf-8')
        
        result_real = service.transcribe_base64_audio(audio_base64, "wav")
        
        print(f"R√©sultat r√©el: {json.dumps(result_real, indent=2)}")
        
        # Nettoyer
        if os.path.exists(TEST_AUDIO_FILE):
            os.remove(TEST_AUDIO_FILE)
        
        has_text_simulated = result.get("text", "").strip() != ""
        has_text_real = result_real.get("text", "").strip() != ""
        
        print(f"Simul√© a du texte: {has_text_simulated}")
        print(f"R√©el a du texte: {has_text_real}")
        
        return has_text_real  # Le vrai test est avec de la vraie parole
        
    except Exception as e:
        print(f"‚ùå Erreur test direct: {e}")
        return False

def test_api_endpoints():
    """Test de tous les endpoints API."""
    print("üåê Test endpoints API...")
    
    if not test_backend_health():
        print("‚ö†Ô∏è  Backend non accessible, tests API annul√©s")
        return False
    
    tests = [
        ("/test-whisper", "GET"),
        ("/whisper/transcribe", "POST"),
        ("/api/whisper/transcribe", "POST")
    ]
    
    results = []
    
    for endpoint, method in tests:
        print(f"  Test {method} {endpoint}...")
        
        try:
            if method == "GET":
                response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
            else:  # POST
                # Cr√©er un audio de test
                create_speech_audio(TEST_AUDIO_FILE, duration=2)
                
                with open(TEST_AUDIO_FILE, 'rb') as f:
                    audio_data = f.read()
                    audio_base64 = base64.b64encode(audio_data).decode('utf-8')
                
                payload = {
                    "audio_base64": audio_base64,
                    "audio_format": "wav",
                    "language": "fr"
                }
                
                response = requests.post(f"{API_BASE_URL}{endpoint}", json=payload, timeout=30)
            
            print(f"    Status: {response.status_code}")
            if response.status_code == 200:
                result = response.json()
                print(f"    Response: {json.dumps(result, indent=2)}")
                results.append(True)
            else:
                print(f"    ‚ùå Erreur: {response.status_code}")
                results.append(False)
                
        except Exception as e:
            print(f"    ‚ùå Exception: {e}")
            results.append(False)
    
    # Nettoyer
    if os.path.exists(TEST_AUDIO_FILE):
        os.remove(TEST_AUDIO_FILE)
    
    return any(results)

def test_file_upload():
    """Test d'upload de fichier audio."""
    print("üìÅ Test upload fichier...")
    
    if not test_backend_health():
        print("‚ö†Ô∏è  Backend non accessible, test upload annul√©")
        return False
    
    try:
        # Cr√©er un fichier audio de test
        create_real_speech_audio(TEST_AUDIO_FILE, "Test d'upload de fichier audio.")
        
        # Upload du fichier
        with open(TEST_AUDIO_FILE, 'rb') as f:
            files = {'audio': ('test.wav', f, 'audio/wav')}
            data = {'language': 'fr'}
            
            response = requests.post(
                f"{API_BASE_URL}/api/whisper/transcribe",
                files=files,
                data=data,
                timeout=30
            )
        
        print(f"Status: {response.status_code}")
        if response.status_code == 200:
            result = response.json()
            print(f"Response: {json.dumps(result, indent=2)}")
            
            # Nettoyer
            if os.path.exists(TEST_AUDIO_FILE):
                os.remove(TEST_AUDIO_FILE)
            
            return result.get("text", "").strip() != ""
        else:
            print(f"‚ùå Erreur upload: {response.status_code}")
            return False
            
    except Exception as e:
        print(f"‚ùå Erreur test upload: {e}")
        return False

def test_different_audio_formats():
    """Test avec diff√©rents formats audio."""
    print("üéµ Test formats audio...")
    
    if not test_backend_health():
        print("‚ö†Ô∏è  Backend non accessible, test formats annul√©")
        return False
    
    formats = [
        ("wav", "audio/wav"),
        ("webm", "audio/webm"),
        ("mp3", "audio/mp3")
    ]
    
    results = []
    
    for format_name, mime_type in formats:
        print(f"  Test format {format_name}...")
        
        try:
            # Cr√©er un audio de test
            create_real_speech_audio(TEST_AUDIO_FILE, f"Test format {format_name}.")
            
            # Convertir en base64
            with open(TEST_AUDIO_FILE, 'rb') as f:
                audio_data = f.read()
                audio_base64 = base64.b64encode(audio_data).decode('utf-8')
            
            # Test avec l'endpoint base64
            payload = {
                "audio_base64": audio_base64,
                "audio_format": format_name,
                "language": "fr"
            }
            
            response = requests.post(
                f"{API_BASE_URL}/whisper/transcribe",
                json=payload,
                timeout=30
            )
            
            print(f"    Status: {response.status_code}")
            if response.status_code == 200:
                result = response.json()
                has_text = result.get("text", "").strip() != ""
                print(f"    Texte: '{result.get('text', '')}'")
                results.append(has_text)
            else:
                print(f"    ‚ùå Erreur: {response.status_code}")
                results.append(False)
                
        except Exception as e:
            print(f"    ‚ùå Exception: {e}")
            results.append(False)
    
    # Nettoyer
    if os.path.exists(TEST_AUDIO_FILE):
        os.remove(TEST_AUDIO_FILE)
    
    return any(results)

def test_error_handling():
    """Test de gestion d'erreurs."""
    print("üö® Test gestion erreurs...")
    
    if not test_backend_health():
        print("‚ö†Ô∏è  Backend non accessible, test erreurs annul√©")
        return False
    
    tests = [
        ("Audio vide", {"audio_base64": "", "audio_format": "wav"}),
        ("Audio invalide", {"audio_base64": "invalid_base64", "audio_format": "wav"}),
        ("Format invalide", {"audio_base64": "dGVzdA==", "audio_format": "invalid"}),
    ]
    
    results = []
    
    for test_name, payload in tests:
        print(f"  Test {test_name}...")
        
        try:
            response = requests.post(
                f"{API_BASE_URL}/whisper/transcribe",
                json=payload,
                timeout=10
            )
            
            print(f"    Status: {response.status_code}")
            # On s'attend √† des erreurs 400 ou 500
            if response.status_code in [400, 500]:
                print(f"    ‚úÖ Erreur g√©r√©e correctement")
                results.append(True)
            else:
                print(f"    ‚ùå Erreur non g√©r√©e: {response.status_code}")
                results.append(False)
                
        except Exception as e:
            print(f"    ‚ùå Exception: {e}")
            results.append(False)
    
    return all(results)

def main():
    """Test ULTRA-ROBUSTE complet."""
    print("üöÄ TEST ULTRA-ROBUSTE WHISPER")
    print("=" * 60)
    
    tests = [
        ("Sant√© backend", test_backend_health),
        ("Service direct", test_whisper_service_direct),
        ("Endpoints API", test_api_endpoints),
        ("Upload fichier", test_file_upload),
        ("Formats audio", test_different_audio_formats),
        ("Gestion erreurs", test_error_handling)
    ]
    
    results = []
    
    for test_name, test_func in tests:
        print(f"\nüß™ {test_name}")
        print("-" * 40)
        
        start_time = time.time()
        success = test_func()
        duration = time.time() - start_time
        
        status = "‚úÖ SUCC√àS" if success else "‚ùå √âCHEC"
        print(f"{status} ({duration:.2f}s)")
        
        results.append((test_name, success, duration))
    
    # R√©sum√© d√©taill√©
    print("\n" + "=" * 60)
    print("üìä R√âSUM√â D√âTAILL√â")
    print("=" * 60)
    
    passed = sum(1 for _, success, _ in results if success)
    total = len(results)
    
    for test_name, success, duration in results:
        status = "‚úÖ" if success else "‚ùå"
        print(f"{status} {test_name} ({duration:.2f}s)")
    
    print(f"\nüéØ R√©sultat global: {passed}/{total} tests r√©ussis")
    
    if passed == total:
        print("üéâ PARFAIT ! Tous les tests sont pass√©s !")
        print("‚úÖ Le service Whisper fonctionne parfaitement")
    elif passed >= total * 0.8:
        print("üü° BON ! La plupart des tests sont pass√©s")
        print("‚ö†Ô∏è  Quelques probl√®mes mineurs √† corriger")
    elif passed >= total * 0.5:
        print("üü† MOYEN ! La moiti√© des tests sont pass√©s")
        print("üîß Des probl√®mes significatifs √† r√©soudre")
    else:
        print("üî¥ MAUVAIS ! La plupart des tests ont √©chou√©")
        print("üö® Probl√®mes majeurs √† r√©soudre")
    
    print("\nüîç DIAGNOSTIC:")
    if not any(success for _, success, _ in results[:2]):  # Backend et service direct
        print("‚ùå Le backend n'est pas accessible ou le service Whisper ne fonctionne pas")
        print("   ‚Üí V√©rifiez que le serveur est d√©marr√©: cd backend && python main.py")
        print("   ‚Üí V√©rifiez l'installation de Whisper: pip install faster-whisper")
    elif not results[1][1]:  # Service direct √©choue
        print("‚ùå Le service Whisper ne fonctionne pas correctement")
        print("   ‚Üí V√©rifiez l'installation de faster-whisper")
        print("   ‚Üí V√©rifiez l'espace disque (mod√®le ~244MB)")
    elif not results[2][1]:  # Endpoints API √©chouent
        print("‚ùå Les endpoints API ne fonctionnent pas")
        print("   ‚Üí V√©rifiez la configuration des routes dans main.py")
    else:
        print("‚úÖ Le syst√®me fonctionne correctement")

if __name__ == "__main__":
    main() 